<Page
    x:Class="ObjectCountingExplorer.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:ObjectCountingExplorer"
    xmlns:ctl="using:ObjectCountingExplorer.Controls"
    xmlns:controls="using:Microsoft.Toolkit.Uwp.UI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    SizeChanged="OnPageSizeChanged"
    x:Name="mainPage"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <SolidColorBrush x:Key="CropImageMask" Color="#1F1F1F" Opacity="0.7"/>

        <ctl:EnumMatchToVisibilityConverter x:Key="enumMatchToVisibilityConverter"/>
        <ctl:BooleanToVisibilityConverter x:Key="booleanToVisibilityConverter"/>
        <ctl:ReverseBooleanToVisibilityConverter x:Key="reverseBooleanToVisibilityConverter"/>
        <ctl:ReverseVisibilityConverter x:Key="reverseVisibilityConverter"/>
        <ctl:CollectionCountToVisibilityConverter x:Key="collectionCountToVisibilityConverter"/>
        <ctl:ReverseCollectionCountToVisibilityConverter x:Key="reverseCollectionCountToVisibilityConverter"/>
    </Page.Resources>

    <Grid EntranceNavigationTransitionInfo.IsTargetElement="True">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <CommandBar x:Name="commandBar" Style="{StaticResource PageTitleCommandBarStyle}">
            <AppBarButton Icon="Accept" Label="Analyze" x:Name="analyzeButton" Click="OnAnalyzeImageButtonClicked" Visibility="Collapsed"/>
            <AppBarButton Icon="Video" Label="WebCam" x:Name="webCamButton" Click="OnWebCamButtonClicked"/>
            <AppBarButton Icon="Pictures" Label="Browse" Click="OnBrowseImageButtonClicked"/>
            <AppBarButton Icon="Setting" Label="Settings" AllowFocusOnInteraction="True" IsEnabled="False">
                <AppBarButton.Flyout>
                    <Flyout>
                        <StackPanel>
                            <TextBlock Text="Settings" Style="{StaticResource SubtitleTextBlockStyle}"/>
                        </StackPanel>
                    </Flyout>
                </AppBarButton.Flyout>
            </AppBarButton>
        </CommandBar>

        <ctl:InitialView x:Name="initialView" Grid.Row="1"/>

        <Grid Grid.Row="1" RowSpacing="12" ColumnSpacing="12" Margin="24,12,24,36" Visibility="{Binding ElementName=initialView, Path=Visibility, Converter={StaticResource reverseVisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="0.6*"/>
                <RowDefinition Height="0.4*"/>
            </Grid.RowDefinitions>

            <Grid Background="#1F1F1F">
                <Grid x:Name="webCamHostGrid" Visibility="Collapsed">
                    <ctl:CameraControl x:Name="cameraControl" FlowDirection="LeftToRight" ImageCaptured="CameraControl_ImageCaptured"/>
                </Grid>

                <Grid x:Name="imageGrid" Visibility="Collapsed">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition />
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <Button Background="Transparent" Padding="6" Width="100">
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE8A3;"/>
                                <TextBlock Text="Zoom"/>
                            </StackPanel>
                        </Button>
                        <Button Background="Transparent" Padding="6" Width="100" Click="OnCropImageButtonClicked">
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE7A8;"/>
                                <TextBlock Text="Crop"/>
                            </StackPanel>
                        </Button>
                        <Button Background="Transparent" Padding="6" Width="100" IsEnabled="False">
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE7AD;"/>
                                <TextBlock Text="Rotate"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                    
                    <Grid Grid.Row="1" HorizontalAlignment="Center" Visibility="{Binding EnableCropFeature, Converter={StaticResource reverseBooleanToVisibilityConverter}}">
                        <Image x:Name="image" Stretch="Uniform" PointerReleased="OnPointerReleasedOverImage"/>
                        <Canvas x:Name="objectDetectionVisualizationCanvas" SizeChanged="OnObjectDetectionVisualizationCanvasSizeChanged"/>
                        <Canvas x:Name="imageRegionsCanvas" Visibility="Collapsed"/>
                    </Grid>

                    <Grid Grid.Row="1" Visibility="{Binding EnableCropFeature, Converter={StaticResource booleanToVisibilityConverter}}">
                        <Grid.RowDefinitions>
                            <RowDefinition />
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <controls:ImageCropper x:Name="imageCropper" Mask="{StaticResource CropImageMask}" Background="#1F1F1F"/>
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="12" Padding="12" HorizontalAlignment="Center">
                            <Button Content="Cancel" Click="OnCancelCropImageButtonClicked" Width="120" />
                            <Button Content="Save" Click="OnSaveImageButtonClicked" Width="120" />
                        </StackPanel>
                    </Grid>
                </Grid>

                <Button Background="Black" Width="40" Height="40" VerticalAlignment="Top" HorizontalAlignment="Right" Click="OnCloseImageViewButtonClicked"
                        Visibility="{Binding EnableCropFeature, Converter={StaticResource reverseBooleanToVisibilityConverter}}">
                    <SymbolIcon Symbol="Cancel"/>
                </Button>
            </Grid>

            <Grid Grid.Row="1" Background="#171717">
                <Grid x:Name="summaryGrid" ColumnSpacing="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="0.2*"/>
                        <ColumnDefinition Width="0.8*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel BorderBrush="Red" BorderThickness="1">
                        <TextBlock Text="Products recognized" Style="{StaticResource TitleTextBlockStyle}" Opacity="0.8" HorizontalAlignment="Center"/>
                        <ListView x:Name="recognitionGroupListView" ItemsSource="{Binding RecognitionGroupCollection}" DisplayMemberPath="Name" SelectedValuePath="Group" SelectedValue="{Binding RecognitionGroup, Mode=TwoWay}"/>
                    </StackPanel>

                    <Grid Grid.Column="1" BorderBrush="Blue" BorderThickness="1">

                        <!-- Summary View -->
                        <Grid ColumnSpacing="30" Visibility="{Binding RecognitionGroup, Converter={StaticResource enumMatchToVisibilityConverter}, ConverterParameter='Summary'}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition />
                                <ColumnDefinition />
                            </Grid.ColumnDefinitions>

                            <StackPanel Spacing="12">
                                <TextBlock Text="Items detected by brand" Foreground="White" Opacity="0.8" Style="{StaticResource SubtitleTextBlockStyle}"/>
                                <ctl:AnalyticsChartControl x:Name="chartControl" />
                            </StackPanel>

                            <ScrollViewer Grid.Column="1" HorizontalScrollMode="Disabled">
                                <StackPanel Spacing="20">
                                    <ctl:ProductCollectionControl Title="Low Confidence"    ProductCollection="{Binding LowConfidenceCollection}"    Visibility="{Binding LowConfidenceCollection.Count, Converter={StaticResource collectionCountToVisibilityConverter}}"/>
                                    <ctl:ProductCollectionControl Title="Medium Confidence" ProductCollection="{Binding MediumConfidenceCollection}" Visibility="{Binding MediumConfidenceCollection.Count, Converter={StaticResource collectionCountToVisibilityConverter}}"/>
                                    <ctl:ProductCollectionControl Title="High Confidence"   ProductCollection="{Binding HighConfidenceCollection}"   Visibility="{Binding HighConfidenceCollection.Count, Converter={StaticResource collectionCountToVisibilityConverter}}"/>
                                </StackPanel>
                            </ScrollViewer>
                        </Grid>

                        <!-- Low Confidence -->
                        <Grid Visibility="{Binding RecognitionGroup, Converter={StaticResource enumMatchToVisibilityConverter}, ConverterParameter='LowConfidence'}">
                            <ScrollViewer HorizontalScrollMode="Disabled">
                                <ctl:ProductCollectionControl Title="Low Confidence" ProductCollection="{Binding LowConfidenceCollection}" EnableExtendedView="True"/>
                            </ScrollViewer>
                        </Grid>

                        <!-- Medium Confidence -->
                        <Grid Visibility="{Binding RecognitionGroup, Converter={StaticResource enumMatchToVisibilityConverter}, ConverterParameter='MediumConfidence'}">
                            <ScrollViewer HorizontalScrollMode="Disabled">
                                <ctl:ProductCollectionControl Title="Medium Confidence" ProductCollection="{Binding MediumConfidenceCollection}" EnableExtendedView="True"/>
                            </ScrollViewer>
                        </Grid>

                        <!-- High Confidence -->
                        <Grid Visibility="{Binding RecognitionGroup, Converter={StaticResource enumMatchToVisibilityConverter}, ConverterParameter='HighConfidence'}">
                            <ScrollViewer HorizontalScrollMode="Disabled">
                                <ctl:ProductCollectionControl Title="High Confidence" ProductCollection="{Binding HighConfidenceCollection}" EnableExtendedView="True"/>
                            </ScrollViewer>
                        </Grid>

                    </Grid>

                    <ProgressRing Grid.Column="1" x:Name="progressRing" Width="100" Height="100" Foreground="White"/>

                </Grid>

            </Grid>
        </Grid>

    </Grid>
</Page>
